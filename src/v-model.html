<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>v-model实现</title>
</head>
<body>
  <div id="app">
    <input type="text" v-model='inputVal' />
    <button type="button" v-click="increment">增加</button>
    <h3 v-bind="inputVal"></h3>
  </div>
  </div>

    <script>

      //初始化数据
      //defineproperty定义数据,添加set劫持，(发布)执行watchers
      //compiler解析指令, 添加v-model的input事件监听，添加回调修改数据（触发setter），同时添加订阅， v-bind订阅
      //定义watcher节点，以及相应的update dom的方法

        function myVue(options) {
          this._init(options)
        }

        myVue.prototype._init = function (options) {
          this.$options = options
          this.$el = document.querySelector(options.el)
          this.$data = options.data
          this.$methods = options.methods
          this._binding = {}

          this._obverse(this.$data)
          this._compile(this.$el)
        }

        myVue.prototype._obverse = function (obj) {
          var value
          for (key in obj) {
            if (obj.hasOwnProperty(key)) {
              value = obj[key]
              this._binding[key] = {
                _directives: []
              }

              var binding = this._binding[key]


              if (typeof value === 'object') {
                this._obverse(value)
              }
              Object.defineProperty(this, key, {
                enumerable: true,
                configurable: true,
                get: function () {
                  console.log(`获取${value}`);
                  return value
                },
                set: function (newVal) {
                  console.log(`更新${value}`);
                  if (value !== newVal) {
                    value = newVal
                    binding._directives.forEach(function (item) {
                      item.update()
                    })
                  }
                }
              })
            }
          }
        }

        myVue.prototype._compile = function (root) {
          console.log(root);
          var _this = this;
          var nodes = root.children
          for (var i = 0; i < nodes.length; i++) {
            var node = nodes[i]
            if (node.children.length) {
              this._compile(node.children)
            }

            if (node.hasAttribute('v-model') && (node.tagName === 'INPUT' || node.tagName == 'TEXTAREA')) {
              node.addEventListener('input', (function (key) {
                var attrVal = node.getAttribute('v-model')
                _this._binding[attrVal]._directives.push(new Watcher('input', node, _this, attrVal, 'value'))
                return function() {
                  _this[attrVal] = nodes[key].value
                }
              })(i))
            }
            if (node.hasAttribute('v-click')) {
              node.onclick = (function () {
                return _this.$methods[node.getAttribute('v-click')].bind(_this)
              })()
            }
            if (node.hasAttribute('v-bind')) {
              var attrVal = node.getAttribute('v-bind')
              _this._binding[attrVal]._directives.push(new Watcher(
                'text',
                node,
                _this,
                attrVal,
                'innerHTML'
              ))
            }
          }
        }

        function Watcher(name, el, vm, exp, attr) {
          this.name = name
          this.el = el
          this.vm = vm
          this.exp = exp
          this.attr = attr

          this.update()
        }
        Watcher.prototype.update = function () {
          this.el[this.attr] = this.vm[this.exp]
        }


      var app = new myVue({
        el: '#app',
        data: {
          inputVal: 0
        },
        methods: {
          increment: function() {
            console.log(this);
            this.inputVal ++
          }
        }
      })
    </script>
</body>
</html>